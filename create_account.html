<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SidraFly â€” Create Account</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">
<style>
  :root{
    --bg-1:#0d0d17;
    --bg-2:#030314;
    --card-bg: rgba(255,255,255,0.06);
    --muted: rgba(255,255,255,0.85);
    --muted-2: rgba(255,255,255,0.68);
    --accent1:#b376ff;
    --accent2:#ff8b2c;
    --input-bg: rgba(255,255,255,0.08);
    --input-text:#ffffff;
    --border: rgba(255,255,255,0.03);
  }
  /* Light theme overrides (applied when .light on html) */
  html.light {
    --bg-1: #f4f6fb;
    --bg-2: #ffffff;
    --card-bg: rgba(0,0,0,0.04);
    --muted: #111827;
    --muted-2: #374151;
    --input-bg: #ffffff;
    --input-text: #0b1220;
    --border: rgba(0,0,0,0.06);
  }

  html,body{height:100%;margin:0;font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto; -webkit-font-smoothing:antialiased;}
  body{
    background: linear-gradient(180deg,var(--bg-1),var(--bg-2));
    color:var(--muted);
    -webkit-font-smoothing:antialiased;
  }

  header{
    position:fixed; left:0; right:0; top:0; height:64px;
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 16px; z-index:1000;
    background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--border);
  }
  .brand{ font-weight:700; font-size:1.05rem; background:linear-gradient(90deg,var(--accent2),var(--accent1)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  .header-actions{ display:flex; gap:10px; align-items:center; }
  .icon-btn{ background: rgba(255,255,255,0.02); border:1px solid var(--border); padding:8px; border-radius:10px; cursor:pointer; color:var(--muted); }

  main{ padding:88px 16px 36px; display:flex; justify-content:center; }
  .card{ width:100%; max-width:360px; background:var(--card-bg); border-radius:16px; padding:20px; box-shadow:0 12px 40px rgba(0,0,0,0.5); border:1px solid var(--border); backdrop-filter: blur(8px); }

  .title{ text-align:center; font-size:1.28rem; font-weight:700; margin-bottom:6px; background:linear-gradient(90deg,var(--accent1),var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  .subtitle{ text-align:center; color:var(--muted-2); font-size:0.88rem; margin-bottom:18px; }

  .field{ margin-bottom:14px; }
  .label{ display:flex; align-items:center; gap:8px; font-weight:600; color:var(--muted-2); margin-bottom:8px; }
  .label i{ color:var(--accent1); font-size:18px; }

  .input{ width:100%; padding:12px 12px; border-radius:10px; border:none; outline:none; background:var(--input-bg); color:var(--input-text); font-size:15px; box-shadow: inset 0 6px 18px rgba(0,0,0,0.35); }
  select.input{ appearance:none; }

  /* Phone row */
  .phone-row{ display:flex; gap:10px; align-items:center; }
  .phone-left{ min-width:120px; display:flex; align-items:center; gap:8px; padding:10px; border-radius:10px; background:var(--input-bg); cursor:pointer; border:1px solid var(--border); color:var(--input-text); }
  .phone-left .flag{ font-size:18px; margin-left:6px; }
  .phone-right{ flex:1; }

  /* password */
  .password-wrap{ position:relative; }
  .pw-toggle{ position:absolute; right:10px; top:50%; transform:translateY(-50%); background:transparent; border:none; cursor:pointer; padding:6px; display:flex; align-items:center; justify-content:center; }
  .pw-toggle svg{ width:20px; height:20px; opacity:0.9; fill:var(--muted); }
  .pw-meter{ height:7px; border-radius:6px; background: rgba(255,255,255,0.06); margin-top:8px; overflow:hidden; }
  .pw-meter > i{ display:block; height:100%; width:0%; transition:width .25s ease, background .25s ease; }

  #matchMsg{ text-align:right; margin-top:6px; font-weight:600; }

  .divider{ height:2px; border-radius:10px; background: linear-gradient(90deg,var(--accent1),var(--accent2)); margin:18px 0; box-shadow:0 6px 20px rgba(179,118,255,0.06); }

  .btn{ width:100%; padding:12px; border-radius:24px; border:none; background: linear-gradient(90deg,var(--accent1),var(--accent2)); color:#120e13; font-weight:700; cursor:pointer; font-size:15px; box-shadow:0 10px 30px rgba(179,118,255,0.08); }

  footer{ text-align:center; margin-top:8px; color:var(--muted-2); font-size:13px; }

/* ===== FIX: modal clarity (95% opaque) ===== */
.modal-backdrop {
  position: fixed;
  inset: 0;
  display: none;
  align-items: flex-start;
  justify-content: center;
  padding-top: 80px;
  z-index: 90;

  /* darker overlay behind modal */
  background: rgba(0, 0, 0, 0.45);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}

.modal-backdrop.open, .modal-backdrop[aria-hidden="false"] {
  display: flex;
}

/* Modal card: almost-solid glass so background doesn't show through */
.modal-card {
  width: 92%;
  max-width: 520px;
  border-radius: 12px;

  /* 95% opaque darker card */
  background: rgba(10, 10, 18, 0.95) !important;
  border: 1px solid rgba(255,255,255,0.06);
  box-shadow: 0 16px 40px rgba(0,0,0,0.6);
  padding: 12px;
  color: #fff;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

/* Make list items more readable (less transparency) */
.country-list { max-height: 60vh; overflow:auto; padding:6px 4px; border-radius:8px; }
.country-item {
  display:flex; justify-content:space-between; align-items:center;
  padding:10px 8px; border-radius:8px; cursor:pointer;
  background: rgba(20,20,28,0.95); /* almost solid */
}
.country-item:hover { background: rgba(40,40,55,1); }
.country-left { display:flex; align-items:center; gap:10px; }
.country-flag { font-size:20px; }
.country-name { font-weight:600; color:#fff; }
.country-code { color: var(--muted); font-weight:700; }

  @media (max-width:420px){
    .card{ padding:16px; max-width:360px; }
    header{ padding:8px 12px; }
  }
</style>
</head>
<body>
<header>
  <div class="brand">SidraFly</div>
  <div class="header-actions">
    <button id="themeToggle" class="icon-btn" title="Toggle theme">ðŸŒ™</button>
    <button id="gotoAuth" class="icon-btn" title="Login">Login</button>
  </div>
</header>

<main>
  <div class="card" role="form" aria-labelledby="createTitle">
    <div id="createTitle" class="title">Create Account</div>
    <div class="subtitle">Join SidraFly â€” secure bookings & blockchain payments</div>

    <div class="field">
      <label class="label"><i class="fi fi-rr-user"></i>Full Name</label>
      <input id="fullname" class="input" type="text" placeholder="e.g. Muhammad Nisar" autocomplete="name">
    </div>

    <div class="field">
      <label class="label"><i class="fi fi-rr-envelope"></i>Email Address</label>
      <input id="email" class="input" type="email" placeholder="you@example.com" autocomplete="email">
    </div>

    <div class="field">
      <label class="label"><i class="fi fi-rr-smartphone"></i>Contact Number</label>
      <div class="phone-row">
        <div id="phoneLeft" class="phone-left" role="button" aria-haspopup="dialog" title="Select country code">
          <span id="phoneLeftFlag" class="flag">ðŸ‡µðŸ‡°</span>
          <span id="phoneLeftCode" style="color:var(--muted-2);">+92</span>
          <span style="margin-left:auto;color:var(--muted-2)">â–¾</span>
        </div>
        <div class="phone-right">
          <input id="phoneNumber" class="input" type="tel" placeholder="300 1234567" inputmode="tel" autocomplete="tel-national">
        </div>
      </div>
    </div>

    <div class="field">
      <label class="label"><i class="fi fi-rr-venus-mars"></i>Gender</label>
      <div id="genderSel" class="input" role="button" tabindex="0">Select gender â–¾</div>
    </div>

    <div class="field">
      <label class="label"><i class="fi fi-rr-calendar"></i>Date of Birth</label>
      <input id="dob" class="input" type="date" max="2025-11-20">
    </div>

    <div class="field">
      <label class="label"><i class="fi fi-rr-globe"></i>Nationality</label>
      <input id="nationality" class="input" type="text" readonly placeholder="Tap to select nationality">
    </div>

    <div class="field">
      <label class="label"><i class="fi fi-rr-flag"></i>Country of Residence</label>
      <input id="country" class="input" type="text" readonly placeholder="Tap to select country">
    </div>

    <div class="field">
      <label class="label"><i class="fi fi-rr-id-badge"></i>ID / Passport Number</label>
      <input id="idPassport" class="input" type="text" placeholder="National ID or Passport number">
    </div>

    <div class="field password-wrap">
      <label class="label"><i class="fi fi-rr-lock"></i>Set Password</label>
      <input id="password" class="input" type="password" autocomplete="new-password" placeholder="Choose a strong password">
      <button class="pw-toggle" id="pwToggle" aria-label="Show password" title="Show/Hide password"></button>
      <div class="pw-meter"><i id="pwFill"></i></div>
      <div id="pwMsg" style="margin-top:6px;color:var(--muted-2);font-size:13px">Use at least 8 characters with letters, numbers & symbols.</div>
    </div>

    <div class="field password-wrap">
      <label class="label"><i class="fi fi-rr-check"></i>Confirm Password</label>
      <input id="password2" class="input" type="password" autocomplete="new-password" placeholder="Repeat password">
      <button class="pw-toggle" id="pwToggle2" aria-label="Show confirm password" title="Show/Hide password"></button>
      <div id="matchMsg" style="margin-top:6px;font-weight:600;"></div>
    </div>

    <div class="divider" aria-hidden="true"></div>

    <button id="createAccount" class="btn">Create Account</button>

    <footer>
      Already have an account? <a href="auth.html" style="color:var(--accent2); text-decoration:none;">Sign in</a>
      <div style="margin-top:8px;color:var(--muted-2);font-size:13px">All rights reserved. SidraFly 2025</div>
    </footer>
  </div>
</main>

<!-- Modal shared for Phone / Nationality / Country / Gender -->
<div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <input id="modalSearch" class="modal-search" placeholder="Search country or code...">
    <div id="modalList" class="country-list" role="list"></div>
    <div style="text-align:center; margin-top:10px;"><button id="modalClose" class="icon-btn">Close</button></div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>

<script>
/* ===========================
   Initialization & helpers
   =========================== */
if (typeof firebase === 'undefined') {
  console.warn('Firebase SDK not loaded. Make sure firebase-config.js exists and defines firebaseConfig.');
}
let auth=null, db=null;
try{
  firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
} catch(e){
  console.warn('Firebase init skipped (firebase-config.js may be missing).', e);
}

/* Elements */
const themeToggle = document.getElementById('themeToggle');
const gotoAuth = document.getElementById('gotoAuth');
const phoneLeft = document.getElementById('phoneLeft');
const phoneLeftFlag = document.getElementById('phoneLeftFlag');
const phoneLeftCode = document.getElementById('phoneLeftCode');
const phoneNumber = document.getElementById('phoneNumber');
const nationalityInput = document.getElementById('nationality');
const countryInput = document.getElementById('country');
const genderSel = document.getElementById('genderSel');

const modalBackdrop = document.getElementById('modalBackdrop');
const modalSearch = document.getElementById('modalSearch');
const modalList = document.getElementById('modalList');
const modalClose = document.getElementById('modalClose');

const pw = document.getElementById('password');
const pw2 = document.getElementById('password2');
const pwFill = document.getElementById('pwFill');
const pwMsg = document.getElementById('pwMsg');
const matchMsg = document.getElementById('matchMsg');
const pwToggle = document.getElementById('pwToggle');
const pwToggle2 = document.getElementById('pwToggle2');

const createBtn = document.getElementById('createAccount');

/* Active selector type for modal: 'phone'|'nationality'|'country'|'gender' */
let activeSelector = null;

/* Default theme: dark */
(function initTheme(){
  const saved = localStorage.getItem('sidraTheme');
  if(saved === 'light'){
    document.documentElement.classList.add('light');
    themeToggle.textContent = 'â˜€ï¸';
  } else {
    document.documentElement.classList.remove('light');
    themeToggle.textContent = 'ðŸŒ™';
  }
})();
themeToggle.addEventListener('click', ()=>{
  const isLight = document.documentElement.classList.toggle('light');
  themeToggle.textContent = isLight ? 'â˜€ï¸' : 'ðŸŒ™';
  localStorage.setItem('sidraTheme', isLight ? 'light' : 'dark');
});

/* goto auth */
gotoAuth.addEventListener('click', ()=> location.href = 'auth.html');

/* ===========================
   SVG Icons for show/hide (iOS-style rounded)
   =========================== */
const eyeSVG = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 5c4.97 0 9 5.33 9 7s-4.03 7-9 7-9-5.33-9-7 4.03-7 9-7zm0 2c-2.49 0-4.5 2.99-4.5 5s2.01 5 4.5 5 4.5-2.99 4.5-5-2.01-5-4.5-5zm0 1.5a3.5 3.5 0 100 7 3.5 3.5 0 000-7z" /></svg>`;
const eyeOffSVG = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M2 3l2 2 3 3C4.9 10.1 3.3 11.9 2 13c0 0 4.03 7 10 7 1.99 0 3.76-.44 5.37-1.2L20 22l2-2L4 1 2 3zM7.5 10.5c.6-.74 1.5-1.5 2.5-1.5 2.21 0 4 1.79 4 4 0 1-.77 1.9-1.5 2.5l-5-5z" /></svg>`;

/* Set initial icons */
pwToggle.innerHTML = eyeSVG;
pwToggle2.innerHTML = eyeSVG;

/* Toggle password visibility */
pwToggle.addEventListener('click', ()=> {
  if(pw.type === 'password'){ pw.type = 'text'; pwToggle.innerHTML = eyeOffSVG; } else { pw.type = 'password'; pwToggle.innerHTML = eyeSVG; }
});
pwToggle2.addEventListener('click', ()=> {
  if(pw2.type === 'password'){ pw2.type = 'text'; pwToggle2.innerHTML = eyeOffSVG; } else { pw2.type = 'password'; pwToggle2.innerHTML = eyeSVG; }
});

/* ===========================
   Password strength & match
   =========================== */
function calcStrength(v){
  let s=0;
  if(!v) return 0;
  if(v.length >= 8) s++;
  if(/[A-Z]/.test(v)) s++;
  if(/[0-9]/.test(v)) s++;
  if(/[^A-Za-z0-9]/.test(v)) s++;
  return s; // 0..4
}
function updateStrength(){
  const s = calcStrength(pw.value);
  const pct = (s/4)*100;
  pwFill.style.width = pct + '%';
  if(s <= 1){ pwFill.style.background = '#ff6b6b'; pwMsg.textContent = 'Weak â€” add capitals, numbers & symbols'; }
  else if(s === 2){ pwFill.style.background = '#ff8b2c'; pwMsg.textContent = 'Okay â€” could be stronger'; }
  else if(s === 3){ pwFill.style.background = '#60a5fa'; pwMsg.textContent = 'Strong'; }
  else { pwFill.style.background = 'linear-gradient(90deg,#6ee7b7,#60a5fa)'; pwMsg.textContent = 'Excellent'; }
  checkMatch();
}
function checkMatch(){
  if(!pw2.value){ matchMsg.textContent = ''; return; }
  if(pw.value === pw2.value){ matchMsg.textContent = 'Passwords match'; matchMsg.style.color = '#7bff7b'; }
  else { matchMsg.textContent = 'Passwords do not match'; matchMsg.style.color = '#ff6b6b'; }
}
pw.addEventListener('input', updateStrength);
pw2.addEventListener('input', checkMatch);

/* ===========================
   Load countries.json (external file)
   =========================== */
let COUNTRIES = [];
fetch('data/countries.json')
  .then(r => r.ok ? r.json() : Promise.reject('countries.json not found'))
  .then(json => {
    COUNTRIES = json;
    COUNTRIES.sort((a,b) => a.name.localeCompare(b.name));
    populateModalList(); // initial populate if modal open later
  })
  .catch(err => {
    console.error('Failed to load countries.json', err);
    // fallback minimal list if file missing
    COUNTRIES = [
      {"name":"Pakistan","flag":"ðŸ‡µðŸ‡°","code":"+92"},
      {"name":"United States","flag":"ðŸ‡ºðŸ‡¸","code":"+1"},
      {"name":"United Kingdom","flag":"ðŸ‡¬ðŸ‡§","code":"+44"},
      {"name":"India","flag":"ðŸ‡®ðŸ‡³","code":"+91"}
    ];
  });

/* ===========================
   Modal handlers (shared)
   =========================== */
function openModal(type){
  activeSelector = type;
  modalBackdrop.classList.add('open');
  modalBackdrop.setAttribute('aria-hidden','false');
  modalSearch.value = '';
  renderModalList(COUNTRIES);
  setTimeout(()=> modalSearch.focus(), 120);
}
function closeModal(){
  activeSelector = null;
  modalBackdrop.classList.remove('open');
  modalBackdrop.setAttribute('aria-hidden','true');
  modalList.innerHTML = '';
}
modalClose.addEventListener('click', closeModal);
modalBackdrop.addEventListener('click', (e) => { if(e.target === modalBackdrop) closeModal(); });

modalSearch.addEventListener('input', ()=> {
  const q = modalSearch.value.trim().toLowerCase();
  const filtered = COUNTRIES.filter(c => c.name.toLowerCase().includes(q) || c.code.toLowerCase().includes(q));
  renderModalList(filtered);
});

function renderModalList(list){
  modalList.innerHTML = '';
  if(activeSelector === 'gender'){
    const genders = ['Male','Female','Other','Prefer not to say'];
    genders.forEach(g => {
      const d = document.createElement('div'); d.className = 'country-item';
      d.innerHTML = `<div class="flag-col">âš¥</div><div class="country-name">${g}</div>`;
      d.addEventListener('click', ()=> { genderSel.textContent = g; closeModal(); });
      modalList.appendChild(d);
    });
    return;
  }
  list.forEach(c => {
    const el = document.createElement('div'); el.className = 'country-item';
    el.innerHTML = `<div class="flag-col">${c.flag}</div><div class="country-name">${c.name}</div><div style="color:var(--muted-2)">${c.code}</div>`;
    el.addEventListener('click', ()=> {
      if(activeSelector === 'phone'){
        phoneLeftFlag.textContent = c.flag;
        phoneLeftCode.textContent = c.code;
        closeModal();
        phoneNumber.focus();
      } else if(activeSelector === 'nationality'){
        nationalityInput.value = c.flag + ' ' + c.name;
        closeModal();
      } else if(activeSelector === 'country'){
        countryInput.value = c.flag + ' ' + c.name;
        closeModal();
      }
    });
    modalList.appendChild(el);
  });
}

/* Hook UI triggers */
phoneLeft.addEventListener('click', ()=> openModal('phone'));
document.getElementById('nationality').addEventListener('click', ()=> openModal('nationality'));
document.getElementById('country').addEventListener('click', ()=> openModal('country'));
genderSel.addEventListener('click', ()=> openModal('gender'));

/* ===========================
   Make sure phone field allows typing after selecting code
   =========================== */
phoneNumber.addEventListener('focus', ()=> {
  // no-op; input is editable
});

/* ===========================
   Create account with Firebase (Auth + Firestore)
   =========================== */
createBtn.addEventListener('click', async () => {
  const fullName = document.getElementById('fullname').value.trim();
  const email = document.getElementById('email').value.trim();
  const phone = (phoneLeftCode.textContent || '') + ' ' + phoneNumber.value.trim();
  const gender = genderSel.textContent.includes('Select') ? '' : genderSel.textContent;
  const dob = document.getElementById('dob').value;
  const nationality = nationalityInput.value.trim();
  const country = countryInput.value.trim();
  const idPassport = document.getElementById('idPassport').value.trim();
  const password = pw.value;
  const password2 = pw2.value;

  if(!fullName || !email || !phoneNumber.value.trim() || !password || !password2){
    alert('Please fill required fields: Name, Email, Phone, Passwords.');
    return;
  }
  if(password !== password2){
    alert('Passwords do not match.');
    return;
  }
  if(calcStrength(password) < 2){
    if(!confirm('Your password looks weak. Proceed anyway?')) return;
  }
  if(!auth){
    alert('Firebase not initialized. Please add your firebase-config.js with firebaseConfig.');
    return;
  }

  createBtn.disabled = true;
  createBtn.textContent = 'Creating...';

  try {
    // 1) create user
    const userCred = await auth.createUserWithEmailAndPassword(email, password);
    const user = userCred.user;

    // 2) save profile in Firestore
    await db.collection('users').doc(user.uid).set({
      fullName,
      email,
      phone,
      gender,
      dob,
      nationality,
      country,
      idPassport,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // 3) send verification email
    await user.sendEmailVerification();
    alert('Verification link sent, please check your inbox.');

    // 4) redirect to auth page after short delay
    setTimeout(()=> { location.href = 'auth.html'; }, 1800);

  } catch (err) {
    console.error(err);
    alert(err.message || 'Signup failed. See console for details.');
    createBtn.disabled = false;
    createBtn.textContent = 'Create Account';
  }
});

/* Accessibility: keyboard open modal on Enter */
['phoneLeft','genderSel','nationality','country'].forEach(id => {
  const el = document.getElementById(id);
  if(el) el.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); el.click(); }});
});

/* Populate modal if countries already loaded */
function populateModalList(){ if(modalBackdrop.classList.contains('open')) renderModalList(COUNTRIES); }

/* End of script */
</script>
</body>
</html>
