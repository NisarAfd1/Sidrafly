<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SidraFly — Sign In</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">

  <style>
    :root {
      --accent:#b376ff;
      --accent2:#ff8b2c;
      --bg: radial-gradient(circle at 50% 20%, #120021 0%, #050009 100%);
      --text:#f0eaff;
      --muted:#b3a9c8;
      --card: rgba(26,12,45,0.85);
      --glass: rgba(179,118,255,0.18);
    }

    html, body {
      margin:0;
      height:100%;
      font-family:'Poppins',sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }

    .card {
      width:100%;
      max-width:400px;
      background:var(--card);
      border-radius:24px;
      padding:28px 26px;
      border:1px solid var(--glass);
      backdrop-filter:blur(14px);
      box-shadow:0 8px 30px rgba(0,0,0,0.45);
    }

    .logo {
      display:block;
      margin:0 auto 12px;
      width:85px;height:85px;
      border-radius:50%;
      border:2px solid rgba(255,255,255,0.15);
      box-shadow:0 0 25px rgba(179,118,255,0.7);
    }

    h1 {
      text-align:center;
      font-size:28px;
      margin:10px 0;
      color:#fff;
    }

    h1 span {color:var(--accent2);}
    p.lead {
      text-align:center;
      color:var(--muted);
      margin:0 0 20px;
    }

    .social-btn {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:13px;
      border-radius:14px;
      border:none;
      cursor:pointer;
      font-weight:600;
      margin-bottom:12px;
      transition:all 0.25s ease;
      width:100%;
    }

    .google {background:#fff; color:#222;}
    .apple {background:#000; color:#fff;}
    .email {
      background:rgba(255,255,255,0.08);
      color:var(--text);
      border:1px solid rgba(255,255,255,0.1);
    }

    .social-btn:hover {
      transform:scale(1.03);
      box-shadow:0 0 12px rgba(179,118,255,0.4);
    }

    .divider {
      display:flex;
      align-items:center;
      gap:12px;
      margin:18px 0;
      color:var(--muted);
      font-size:0.9rem;
    }

    .divider hr {
      flex:1;
      border:none;
      height:1px;
      background:linear-gradient(90deg, rgba(255,255,255,0.05), rgba(179,118,255,0.8), rgba(255,255,255,0.05));
      box-shadow:0 0 10px rgba(179,118,255,0.7);
      border-radius:50px;
    }

    input {
      width:94%;
      display:block;
      margin:auto;
      padding:12px 14px;
      margin-bottom:12px;
      border:1px solid rgba(255,255,255,0.1);
      border-radius:12px;
      background:rgba(255,255,255,0.06);
      color:var(--text);
      font-size:0.95rem;
      transition:all 0.25s ease;
    }

    /* Email glow — sharp orange edge */
    #emailInput:focus {
      outline:none;
      border-color:#ffae42;
      box-shadow:0 0 8px #ffae42, inset 0 0 3px rgba(255,140,0,0.4);
      background:rgba(255,255,255,0.08);
    }

    /* Password glow — sharp red edge */
    #passwordInput:focus {
      outline:none;
      border-color:#ff4747;
      box-shadow:0 0 8px #ff4747, inset 0 0 3px rgba(255,70,70,0.4);
      background:rgba(255,255,255,0.08);
    }

    input::placeholder {color:var(--muted);}

    /* Forgot password alignment fix */
    .forgot-row {
      width:94%;
      margin:auto;
      text-align:right;
      margin-bottom:10px;
      padding-right:-9px;
    }

    .primary {
      width:94%;
      display:block;
      margin:auto;
      padding:13px;
      border:none;
      border-radius:12px;
      background:linear-gradient(90deg,var(--accent2),var(--accent));
      color:#fff;
      font-weight:600;
      cursor:pointer;
      margin-top:6px;
      transition:0.3s;
      font-size:1rem;
      box-shadow:0 0 10px rgba(179,118,255,0.25);
    }

    .primary:hover {opacity:0.9;transform:scale(1.02);}
    .link { color:var(--accent); cursor:pointer; }
    .small { text-align:center; color:var(--muted); font-size:0.9rem; }
    .error { color:#ff7a7a; font-size:0.9rem; text-align:center; margin-bottom:10px; }
  </style>
</head>
<body>

  <div class="card">
    <img src="sidrafly-logo.png" alt="SidraFly Logo" class="logo">
    <h1>Welcome <span>Back</span></h1>
    <p class="lead">Sign in to your SidraFly account</p>

    <div id="error" class="error"></div>

    <!-- Google -->
    <button class="social-btn google" id="googleBtn">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" height="20" width="20">
      Continue with Google
    </button>

    <!-- Apple -->
    <button class="social-btn apple" id="appleBtn">
      <svg xmlns="http://www.w3.org/2000/svg" fill="#fff" viewBox="0 0 384 512" width="18" height="18">
        <path d="M318.7 268.7c-.3-37.7 17-66.1 53.6-87.2-20-29.2-50.4-45.3-91.5-48-38.4-2.5-80.3 22.8-95.4 22.8-15.5 0-51.1-21.6-79.2-21.6-57.7 0-118.4 47.2-118.4 136.4 0 29.1 5.3 59.3 16 89.6 14.3 39.3 66.3 135.2 120.4 133.6 28.2-.7 48-20.1 84.8-20.1 36.3 0 54.8 20.1 84.9 20.1 54.3-.8 104.1-89.1 118.2-128.6-74.7-28.6-72.9-112.2-73.4-116.9zM257.3 48c24.5-29.6 22.2-56 21.3-66.1-20.7 1.3-44.5 14.1-58.8 31.7-12.8 15.5-24 38.6-21 63 22.7 1.8 45.7-11.6 58.5-28.6z"/>
      </svg>
      Sign in with Apple
    </button>

    <!-- Email -->
    <button class="social-btn email" id="emailBtn">
      <i class="fi fi-rr-envelope"></i> Continue with Email
    </button>

    <div class="divider"><hr><span>Or sign in with password</span><hr></div>

    <input id="emailInput" type="email" placeholder="Email address">
    <input id="passwordInput" type="password" placeholder="Password">

    <div class="forgot-row">
      <span class="link" id="forgotLink">Forgot password?</span>
    </div>

    <button id="pwSignIn" class="primary">Sign In</button>

    <p class="small" style="margin-top:14px;">
      Don’t have an account? <span class="link" id="createLink">Create account</span>
    </p>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="/firebase-config.js"></script>

  <script>
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const googleBtn = document.getElementById('googleBtn');
    const appleBtn = document.getElementById('appleBtn');
    const emailBtn = document.getElementById('emailBtn');
    const pwSignIn = document.getElementById('pwSignIn');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const forgotLink = document.getElementById('forgotLink');
    const createLink = document.getElementById('createLink');
    const errorBox = document.getElementById('error');

    function showError(msg){ errorBox.textContent = msg; setTimeout(()=> errorBox.textContent = '', 7000); }

    googleBtn.addEventListener('click', async ()=>{
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await auth.signInWithPopup(provider);
        await redirectUser(result.user);
      } catch(e){ showError(e.message); }
    });

    appleBtn.addEventListener('click', ()=>{
      alert('Apple sign-in will be added later.');
    });

    emailBtn.addEventListener('click', async ()=>{
      const email = prompt('Enter your email to receive a one-time sign-in link:');
      if(!email) return;
      try{
        await auth.sendSignInLinkToEmail(email, {
          url: window.location.origin + '/auth.html',
          handleCodeInApp: true
        });
        localStorage.setItem('sidraEmail', email);
        alert('Sign-in link sent to ' + email);
      } catch(e){ showError(e.message); }
    });

    if(auth.isSignInWithEmailLink(location.href)){
      let email = localStorage.getItem('sidraEmail');
      if(!email) email = prompt('Enter your email to complete sign-in:');
      auth.signInWithEmailLink(email, location.href)
        .then(res => redirectUser(res.user))
        .catch(e => showError(e.message));
    }

    pwSignIn.addEventListener('click', async ()=>{
      const email = emailInput.value.trim(), pass = passwordInput.value.trim();
      if(!email || !pass) return showError('Please enter both fields.');
      try {
        const result = await auth.signInWithEmailAndPassword(email, pass);
        await redirectUser(result.user);
      } catch(e){ showError(e.message); }
    });

    forgotLink.addEventListener('click', async ()=>{
      const email = prompt('Enter your registered email:');
      if(!email) return;
      try{
        await auth.sendPasswordResetEmail(email);
        alert('Password reset link sent to your email.');
      } catch(e){ showError(e.message); }
    });

    createLink.addEventListener('click', ()=> location.href='create_account.html');

    auth.onAuthStateChanged(user => user && redirectUser(user));

    async function redirectUser(user){
      const ref = db.collection('users').doc(user.uid);
      const doc = await ref.get();
      if(!doc.exists){
        await ref.set({ email:user.email, createdAt:firebase.firestore.FieldValue.serverTimestamp() });
        return location.href='create_account.html';
      }
      location.href='dashboard/home.html';
    }
  </script>
</body>
</html>
